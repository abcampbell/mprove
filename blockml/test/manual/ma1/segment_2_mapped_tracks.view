
# 2_mapped_tracks.view
# mapped_tracks

view: segment_2_mapped_tracks
derived_table: |
  SELECT
    *,
    TIMESTAMP_DIFF(timestamp, LAG(timestamp) OVER(PARTITION BY mprove_visitor_id ORDER BY timestamp), minute) AS idle_time_minutes
  FROM (
    SELECT
      CONCAT(CAST(t.timestamp AS string), t.anonymous_id) AS event_id,
      t.anonymous_id,
      ${a2v.mprove_visitor_id},
      t.timestamp,
      t.event AS event
    FROM
      `mprove-data.segment_javascript.tracks` AS t
    INNER JOIN
      ${segment_1_aliases_mapping AS a2v}
    ON
      ${a2v.alias} = coalesce(t.user_id,
        t.anonymous_id) )
# permanent: true        

        
fields:
- dimension: anonymous_id
  sql: anonymous_id

- dimension: event_id
  sql: event_id
  
- dimension: mprove_visitor_id
  sql: mprove_visitor_id

- dimension: timestamp
  sql: timestamp
  
- time: timestamp_frames
  hidden: true
  timeframes:
  - time
  - date
  - week
  - month
  sql: timestamp
  
- dimension: event
  sql: event
  
- dimension: idle_time_minutes
  sql: idle_time_minutes  

  
  
  
  
  
  
  
  
  
  
  
  
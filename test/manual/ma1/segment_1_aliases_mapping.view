
# 1_aliases_mapping.view
# aliases_mapping 

view: segment_1_aliases_mapping 
derived_table: |
  WITH
    all_mappings AS (
    SELECT
      anonymous_id,
      user_id,
      timestamp AS timestamp
    FROM
      `mprove-data.segment_javascript.tracks`
    UNION DISTINCT
    SELECT
      user_id,
      NULL,
      timestamp
    FROM
      `mprove-data.segment_javascript.tracks` )
      
  SELECT
    DISTINCT anonymous_id AS alias,
    coalesce(FIRST_VALUE(user_id) OVER(PARTITION BY anonymous_id ORDER BY timestamp DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING),
      user_id,
      anonymous_id) AS mprove_visitor_id
  FROM
    all_mappings
# permanent: true

fields:
- dimension: alias
  sql: alias
  
- dimension: mprove_visitor_id
  sql: mprove_visitor_id